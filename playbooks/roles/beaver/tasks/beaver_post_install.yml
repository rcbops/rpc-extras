---
# Copyright 2015, Rackspace US, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#- name: Deploy beaver logfile conf files
#  template:
#    src: "logfile.conf.j2"
#    dest: "/etc/beaver/conf.d/{{ item.name }}"
#    owner: "{{ beaver_daemon_user }}"
#    group: "{{ beaver_daemon_group }}"
#  with_items: beaver_log_monitors
#  when: beaver_log_monitors is defined
#  notify: Restart beaver
#  tags:
#    - beaver-post-install
#    - beaver-conf

- name: Find all log files
  shell: |
    find -L '{{ beaver_log_storage_directory }}' -type f -name '*.log'
  register: log_files
  when: >
    beaver_log_storage_directory is defined
  tags:
    - beaver-conf

- name: Set fact for combined log files list and found logs
  set_fact:
    beaver_log_files: "{{ log_files.stdout_lines | union(beaver_log_files) }}"
  when: >
    beaver_log_files is defined and
    log_files | success
  tags:
    - beaver-conf

- name: Set fact for found log files list
  set_fact:
    beaver_log_files: "{{ log_files.stdout_lines }}"
  when: >
    beaver_log_files is not defined and
    log_files | success
  tags:
    - beaver-conf

- name: Set fact for standard log files
  set_fact:
    beaver_standard_log_files: "[ 'cron.log', 
                                 'CRON.log', 
                                 'dhclient.log', 
                                 'kernel.log', 
                                 'ntpdate.log',
                                 'rsyslogd.log',
                                 'sshd.log' ]"
  tags:
    - beaver-conf

- name: Check for log files
  fail:
    msg: >
      No log files were found in `beaver_log_files`.
  when: >
    beaver_log_files is not defined

- name: Write beaver config for found log files
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "root"
    group: "root"
  with_items:
    - { src: "logfile.conf.j2", dest: "/etc/beaver/conf.d/logfile.conf" }
  tags:
    - beaver-conf

- name: Start Beaver
  service:
    name: "beaver"
    state: "started"
  tags:
    - beaver-conf
